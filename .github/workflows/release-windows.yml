name: Build Windows EXE (jpackage) on tag

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  windows-exe:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Build (Maven)
        working-directory: tictactoe
        run: mvn -B -DskipTests clean package

      - name: Resolve version from tag
        id: ver
        shell: pwsh
        run: |
          $tag = "${env:GITHUB_REF_NAME}"   # e.g. v1.2.3
          $ver = $tag.TrimStart("v")
          "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Prepare jpackage input
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path input | Out-Null
          $jar = Get-ChildItem -Path "tictactoe\target" -Filter *.jar |
            Where-Object { $_.Name -notmatch "(sources|javadoc)\.jar$" } |
            Select-Object -First 1
          if (-not $jar) { throw "No runnable jar found in tictactoe/target/." }
          Copy-Item -Force $jar.FullName ".\input\app.jar"
          Write-Host "Using jar: $($jar.Name)"

      - name: Package EXE with jpackage
        shell: pwsh
        run: |
          jpackage `
            --name "TicTacToe Kviz" `              
            --app-version "${{ steps.ver.outputs.version }}" `
            --input "input" `
            --main-jar "app.jar" `
            --main-class "si.unm_fei.core.Game" `     
            --type exe `
            --dest "dist" `
            --win-shortcut `
            --win-menu `
            --win-dir-chooser

      - name: Attach EXE to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.exe
